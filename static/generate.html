<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-body: #f3f4f6;
            --bg-surface: #ffffff;
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --bg-input: #f9fafb;
        }
        .dark:root {
            --bg-body: #09090b;
            --bg-surface: #18181b;
            --border-color: #27272a;
            --text-main: #e5e7eb;
            --text-sub: #9ca3af;
            --bg-input: rgba(0,0,0,0.3);
        }

        body { background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        .bg-surface { background-color: var(--bg-surface); }
        .border-theme { border-color: var(--border-color); }
        .text-sub { color: var(--text-sub); }
        .bg-input { background-color: var(--bg-input); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .checkerboard {
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* Tooltip */
        .tooltip-wrap { position: relative; }
        .tooltip-wrap:hover::after {
            content: attr(data-tip);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            margin-bottom: 8px; padding: 4px 8px; background: #000; color: #fff;
            font-size: 10px; border-radius: 4px; white-space: nowrap; pointer-events: none;
            opacity: 0; animation: fadeIn 0.2s forwards; z-index: 50;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        /* Banana Loading Animation */
        .banana-loader {
            filter: grayscale(100%) opacity(0.3);
            animation: banana-color 1.5s infinite alternate ease-in-out;
        }
        @keyframes banana-color {
            0% { filter: grayscale(100%) opacity(0.3) blur(1px); transform: scale(0.95); }
            100% { filter: grayscale(0%) opacity(1) blur(0); transform: scale(1.05); }
        }

        /* Sidebar Disabled State */
        .sidebar-disabled {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(0.5);
            transition: all 0.3s;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: "#fbbf24", primary_hover: "#f59e0b" } } }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans">
    <div id="app" v-cloak class="flex h-full">
        <div class="w-[380px] bg-surface border-r border-theme flex flex-col h-full flex-shrink-0 transition-colors duration-300 z-20 shadow-xl relative">
            
            <div class="p-4 border-b border-theme space-y-3">
                <div class="flex items-center justify-between">
                    <h1 class="font-bold text-xl flex items-center gap-2 text-primary tracking-tight">
                        <svg class="w-8 h-8 drop-shadow-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.999 2C12.999 2 13.923 2.932 14.849 5.09C15.775 7.248 15.659 10.395 14.346 13.251C13.033 16.107 10.154 19.825 5.253 21.754C4.846 21.914 4.5 21.461 4.792 21.13C6.388 19.324 8.799 15.669 8.799 11.5" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14.5 5C16.5 5 20 6.5 20 11C20 15.5 17 20 12 21.5" stroke="#fbbf24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.5"/>
                        </svg>
                        Nano Banana
                    </h1>
                    <button @click="toggleTheme" class="p-2 rounded-full hover:bg-input text-sub transition-colors">
                        <i :data-lucide="isDark ? 'moon' : 'sun'" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="flex items-center bg-input rounded px-2 py-1.5 border border-theme focus-within:ring-1 focus-within:ring-primary/50 transition-all" :class="{'sidebar-disabled': isGenerating}">
                    <i data-lucide="key" class="w-3 h-3 text-sub mr-2"></i>
                    <input type="password" v-model="apiKey" class="bg-transparent text-xs w-full outline-none placeholder-gray-500" placeholder="Enter API Key">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 no-scrollbar" :class="{'sidebar-disabled': isGenerating}">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-sub uppercase tracking-wider">Prompt</label>
                    <textarea v-model="prompt" rows="5" class="w-full bg-input border border-theme rounded-lg p-3 text-sm focus:border-primary focus:ring-1 focus:ring-primary/20 outline-none transition-all resize-none font-medium leading-relaxed" placeholder="Describe your banana dream..."></textarea>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-sub uppercase tracking-wider flex justify-between items-center">
                        Reference ({{ refImages.length }})
                        <button v-if="refImages.length" @click="clearImages" class="text-[10px] text-red-400 hover:text-red-300">Clear</button>
                    </label>
                    
                    <div 
                        @dragover.prevent="isDragging = true" 
                        @dragleave.prevent="isDragging = false" 
                        @drop.prevent="handleDrop"
                        @click="$refs.fileInput.click()"
                        class="border-2 border-dashed rounded-lg p-4 transition-all cursor-pointer text-center group relative overflow-hidden"
                        :class="isDragging ? 'border-primary bg-primary/5' : 'border-theme hover:border-gray-400 bg-input'"
                    >
                        <input type="file" ref="fileInput" multiple accept="image/*" class="hidden" @change="handleFileSelect">
                        <div class="flex flex-col items-center justify-center gap-2 py-2 relative z-10">
                            <i data-lucide="image-plus" class="w-6 h-6 text-sub group-hover:text-primary transition-colors"></i>
                            <span class="text-xs text-sub group-hover:text-primary transition-colors">Add References</span>
                        </div>
                    </div>

                    <div v-if="refImages.length" class="grid grid-cols-3 gap-2 mt-3">
                        <div v-for="(img, idx) in refImages" :key="idx" class="relative group aspect-square rounded-md overflow-hidden border border-theme bg-black/50">
                            <img :src="img.previewUrl" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-all cursor-pointer" @click="openEditor(idx)">
                            <div v-if="img.hasMask" class="absolute top-1 left-1 w-1.5 h-1.5 bg-red-500 rounded-full shadow-sm ring-1 ring-black/50"></div>
                            <button @click.stop="removeImage(idx)" class="absolute top-0.5 right-0.5 p-0.5 bg-black/60 rounded text-white opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-6 pt-2">
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-sub uppercase tracking-wider">Model</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button v-for="m in models" :key="m.id" @click="selection.model = m.id"
                                class="relative flex flex-col items-center justify-center px-1 py-3 rounded-lg border transition-all group"
                                :class="selection.model === m.id ? 'bg-primary/10 border-primary text-primary' : 'bg-input border-theme text-sub hover:bg-gray-100 dark:hover:bg-gray-800'">
                                <div class="absolute -top-2.5 px-1.5 py-0.5 rounded text-[9px] font-bold text-white shadow-sm transform scale-90 group-hover:scale-100 transition-transform"
                                     :class="{'bg-blue-500': m.badge === 'Better', 'bg-purple-600': m.badge === 'Best', 'bg-gray-500': m.badge === 'Normal'}">
                                    {{ m.badgeIcon }} {{ m.badge }}
                                </div>
                                <span class="text-[10px] font-semibold mt-1">{{ m.shortName }}</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-sub uppercase tracking-wider">Ratio</label>
                            <div class="flex bg-input rounded-md border border-theme p-0.5">
                                <button @click="selection.aspect = 'landscape'" class="flex-1 py-1.5 rounded flex items-center justify-center transition-colors tooltip-wrap" data-tip="Landscape" :class="selection.aspect === 'landscape' ? 'bg-surface text-primary shadow-sm' : 'text-sub hover:text-main'"><i data-lucide="rectangle-horizontal" class="w-3.5 h-3.5"></i></button>
                                <button @click="selection.aspect = 'portrait'" class="flex-1 py-1.5 rounded flex items-center justify-center transition-colors tooltip-wrap" data-tip="Portrait" :class="selection.aspect === 'portrait' ? 'bg-surface text-primary shadow-sm' : 'text-sub hover:text-main'"><i data-lucide="rectangle-vertical" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-sub uppercase tracking-wider">Count</label>
                            <div class="flex bg-input rounded-md border border-theme p-0.5">
                                <button v-for="n in [1, 2, 4]" :key="n" @click="config.n = n" class="flex-1 py-1 text-xs font-medium rounded transition-colors" :class="config.n === n ? 'bg-surface text-primary shadow-sm' : 'text-sub hover:text-main'">{{ n }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-theme bg-surface">
                <button @click="generate" :disabled="isGenerating || !apiKey" 
                    class="w-full h-11 rounded-lg font-bold text-sm shadow-lg shadow-yellow-900/10 transition-all flex justify-center items-center gap-2 relative overflow-hidden group"
                    :class="isGenerating ? 'bg-surface border-2 border-primary text-primary cursor-not-allowed' : 'bg-primary hover:bg-primary_hover text-black active:scale-[0.98]'">
                    <div v-if="isGenerating" class="flex items-center gap-2 w-full px-4">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin flex-shrink-0"></i>
                        <span class="font-mono text-xs truncate animate-pulse text-left flex-1 opacity-80">{{ streamingLog || 'Initializing...' }}</span>
                    </div>
                    <div v-else class="flex items-center gap-2">
                        <i data-lucide="banana" class="w-4 h-4 transition-transform group-hover:rotate-12"></i>
                        <span>GENERATE</span>
                    </div>
                </button>
            </div>
        </div>

        <div class="flex-1 bg-body flex flex-col min-w-0 relative transition-colors duration-300">
            <div class="flex-1 overflow-y-auto p-4 md:p-8" ref="scrollContainer">
                
                <div v-if="!currentResult.length && !isGenerating && !history.length && !errorMessage" class="h-full flex flex-col items-center justify-center text-sub gap-6 opacity-40 select-none">
                    <div class="w-32 h-32 bg-input rounded-full flex items-center justify-center border-2 border-dashed border-theme">
                        <span class="text-6xl grayscale">üçå</span>
                    </div>
                    <p class="text-sm font-medium tracking-wide">Ready to Peel</p>
                </div>

                <div v-if="isGenerating || currentResult.length > 0 || errorMessage" class="mb-12 flex flex-col h-[calc(100vh-80px)] min-h-[400px]">
                    <div v-if="errorMessage" class="bg-red-500/10 border border-red-500/20 text-red-500 p-3 rounded-lg mb-2 text-xs font-mono whitespace-pre-wrap shake flex-shrink-0">
                        <div class="flex items-start gap-2">
                            <i data-lucide="alert-circle" class="w-4 h-4 mt-0.5"></i>
                            <span>{{ errorMessage }}</span>
                        </div>
                    </div>

                    <div class="flex-1 min-h-0 w-full relative" :class="gridClass">
                        <template v-if="isGenerating && currentResult.length === 0 && !errorMessage">
                            <div v-for="i in config.n" 
                                 class="w-full bg-input rounded-lg border border-theme flex items-center justify-center overflow-hidden"
                                 :class="dynamicAspectClass">
                                <svg class="w-24 h-24 banana-loader" viewBox="0 0 24 24" fill="currentColor" stroke="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.999 2C12.999 2 13.923 2.932 14.849 5.09C15.775 7.248 15.659 10.395 14.346 13.251C13.033 16.107 10.154 19.825 5.253 21.754C4.846 21.914 4.5 21.461 4.792 21.13C6.388 19.324 8.799 15.669 8.799 11.5" class="text-yellow-400"/>
                                </svg>
                            </div>
                        </template>

                        <div v-for="(img, idx) in currentResult" :key="idx" 
                             class="group relative w-full rounded-lg overflow-hidden border border-theme bg-[#000000] shadow-sm hover:border-primary/50 transition-colors flex items-center justify-center"
                             :class="dynamicAspectClass">
                            <img :src="img.url" class="w-full h-full object-contain cursor-zoom-in bg-checkerboard" @click="openLightbox(img, prompt)">
                            
                            <div class="absolute bottom-4 inset-x-0 flex justify-center gap-3 opacity-0 group-hover:opacity-100 transition-all duration-200 translate-y-2 group-hover:translate-y-0">
                                <button @click="addRefImage(img.url)" class="px-3 py-1.5 bg-black/70 backdrop-blur text-white hover:bg-primary hover:text-black rounded-full text-xs font-medium transition-colors flex items-center gap-2 shadow-lg border border-white/10">
                                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                    Ref
                                </button>
                                <a :href="img.url" target="_blank" class="px-3 py-1.5 bg-black/70 backdrop-blur text-white hover:bg-white hover:text-black rounded-full text-xs font-medium transition-colors flex items-center gap-2 shadow-lg border border-white/10">
                                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
                                    Open
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="allHistoryImages.length" class="space-y-6 pt-6 border-t border-theme/50">
                    <div class="flex items-center justify-between text-sub">
                        <div class="flex items-center gap-2">
                            <i data-lucide="archive" class="w-4 h-4"></i>
                            <span class="text-xs font-bold tracking-wider uppercase">History ({{ allHistoryImages.length }})</span>
                        </div>
                        <button @click="clearHistory" class="text-[10px] hover:text-red-400 transition-colors">Clear All</button>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <div v-for="(item, idx) in allHistoryImages" :key="idx" 
                             class="group relative h-40 rounded-lg border border-theme bg-black/5 overflow-hidden transition-transform hover:scale-[1.02] hover:shadow-lg flex-grow"
                             style="flex-basis: 150px; flex-grow: 1; max-width: 300px;">
                            <img :src="item.url" 
                                 class="w-full h-full object-cover cursor-zoom-in opacity-80 group-hover:opacity-100 transition-opacity" 
                                 loading="lazy"
                                 @click="openLightbox(item, item.prompt)">
                        </div>
                        <div class="flex-grow-[10]" style="flex-basis: 150px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <transition name="fade">
            <div v-if="lightbox.show" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center" @click.self="closeLightbox" @keydown.esc="closeLightbox" tabindex="0" ref="lightboxEl">
                
                <button @click="closeLightbox" class="absolute top-4 right-4 p-2 text-white/50 hover:text-white rounded-full transition-colors z-50">
                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>

                <div class="flex-1 w-full h-full flex items-center justify-center p-4 md:p-12 overflow-hidden" @click.self="closeLightbox">
                    <img :src="lightbox.img.url" class="max-w-full max-h-full object-contain shadow-2xl drop-shadow-2xl rounded-sm">
                </div>

                <div class="absolute bottom-0 inset-x-0 p-8 bg-gradient-to-t from-black/90 via-black/60 to-transparent flex flex-col items-center gap-4 text-center pointer-events-none">
                    <p class="text-white/80 text-sm font-medium line-clamp-2 max-w-2xl text-shadow-sm pointer-events-auto select-text">{{ lightbox.prompt }}</p>
                    <div class="flex items-center gap-4 pointer-events-auto">
                        <a :href="lightbox.img.url" target="_blank" class="px-5 py-2 bg-white/10 hover:bg-white/20 border border-white/10 rounded-full text-xs text-white font-medium transition-colors flex items-center gap-2 backdrop-blur-sm">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
                            Open Original
                        </a>
                        <button @click="addRefImage(lightbox.img.url); closeLightbox()" class="px-5 py-2 bg-primary hover:bg-primary_hover text-black rounded-full text-xs font-bold transition-colors flex items-center gap-2 shadow-lg shadow-primary/20">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                            Use as Reference
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="editor.show" class="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-8">
                <div class="bg-surface border border-theme rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden">
                    <div class="h-14 border-b border-theme flex items-center justify-between px-4 bg-surface">
                        <span class="font-bold">Mask Editor</span>
                        <div class="flex gap-2">
                            <button @click="closeEditor(false)" class="px-4 py-1.5 text-xs text-sub hover:text-main">Cancel</button>
                            <button @click="closeEditor(true)" class="px-4 py-1.5 text-xs bg-primary text-black font-bold rounded">Save</button>
                        </div>
                    </div>
                    <div class="flex-1 bg-[#101012] relative overflow-hidden flex items-center justify-center checkerboard">
                        <canvas ref="editorCanvas" class="cursor-crosshair shadow-2xl" @mousedown="startDraw" @mousemove="drawing" @mouseup="stopDraw" @mouseleave="stopDraw"></canvas>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp, ref, reactive, nextTick, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                // --- Core State ---
                const apiKey = ref(localStorage.getItem('nano_key') || '');
                const prompt = ref('');
                const isGenerating = ref(false);
                const streamingLog = ref('');
                const errorMessage = ref('');
                const refImages = ref([]); 
                const currentResult = ref([]);
                const isDragging = ref(false);
                
                // --- Theme ---
                const isDark = ref(localStorage.getItem('theme') !== 'light'); 
                const toggleTheme = () => { isDark.value = !isDark.value; updateTheme(); };
                const updateTheme = () => {
                    document.documentElement.classList.toggle('dark', isDark.value);
                    localStorage.setItem('theme', isDark.value ? 'dark' : 'light');
                };

                // --- Configuration ---
                const models = [
                    { id: 'gemini-2.5-flash', shortName: 'Gem 2.5', badge: 'Better', badgeIcon: '‚ö°', suffix: 'image' },
                    { id: 'gemini-3.0-pro', shortName: 'Gem 3.0', badge: 'Best', badgeIcon: 'üß†', suffix: 'image' },
                    { id: 'imagen-4.0', shortName: 'Imagen', badge: 'Normal', badgeIcon: 'üé®', suffix: 'generate-preview' }
                ];
                
                const selection = reactive({ aspect: 'landscape', model: 'gemini-2.5-flash' });
                const config = reactive({ n: 1 });

                // --- History ---
                const history = ref([]);
                const loadHistory = () => {
                    try {
                        const raw = JSON.parse(localStorage.getItem('nano_history') || '[]');
                        const now = Date.now();
                        const validHistory = raw.filter(item => (now - item.id) < 43200000);
                        
                        if (validHistory.length !== raw.length) {
                            localStorage.setItem('nano_history', JSON.stringify(validHistory));
                        }
                        history.value = validHistory;
                    } catch (e) {
                        history.value = [];
                    }
                };
                const saveHistory = () => localStorage.setItem('nano_history', JSON.stringify(history.value));
                const clearHistory = () => { history.value = []; saveHistory(); };

                // Flatten history for mixed layout
                const allHistoryImages = computed(() => {
                    return history.value.flatMap(item => 
                        item.images.map(img => ({ ...img, prompt: item.prompt, timestamp: item.id }))
                    );
                });

                // --- Lightbox State ---
                const lightbox = reactive({ show: false, img: null, prompt: '' });
                const lightboxEl = ref(null);

                // --- Editor State ---
                const editor = reactive({ show: false, index: -1, brushSize: 30 });
                const editorCanvas = ref(null);
                let ctx = null, isDrawing = false, markdownBuffer = '';

                // --- Computed ---
                const updateIcons = () => nextTick(() => lucide.createIcons());
                watch(apiKey, v => localStorage.setItem('nano_key', v));
                watch(isGenerating, () => updateIcons());
                
                const computedModelName = computed(() => {
                    const m = models.find(x => x.id === selection.model);
                    return m ? `${m.id}-${m.suffix}-${selection.aspect}` : '';
                });

                const gridClass = computed(() => {
                    if (config.n === 1) return 'flex items-center justify-center'; 
                    return 'grid grid-cols-2 gap-4 place-items-center h-full'; 
                });

                const dynamicAspectClass = computed(() => {
                    return selection.aspect === 'landscape' ? 'aspect-video max-h-full' : 'aspect-[3/4] max-h-full';
                });

                // --- Methods ---
                
                const openLightbox = (img, prmt) => {
                    lightbox.img = img;
                    lightbox.prompt = prmt;
                    lightbox.show = true;
                    nextTick(() => lightboxEl.value?.focus());
                };
                const closeLightbox = () => lightbox.show = false;

                const handleDrop = (e) => processFiles(e.dataTransfer.files);
                const handleFileSelect = (e) => processFiles(e.target.files);
                const processFiles = (files) => {
                    if (isGenerating.value) return; // double check
                    isDragging.value = false;
                    for (let file of files) {
                        if (!file.type.startsWith('image/')) continue;
                        const reader = new FileReader();
                        reader.onload = e => refImages.value.push({ file, previewUrl: e.target.result, hasMask: false });
                        reader.readAsDataURL(file);
                    }
                    updateIcons();
                };

                // Fix for CORS: Just add URL, don't try to load/convert yet
                const addRefImage = (url) => {
                    if (isGenerating.value) return;
                    refImages.value.push({ file: null, previewUrl: url, hasMask: false, isRemote: true });
                    updateIcons();
                };
                const removeImage = (idx) => refImages.value.splice(idx, 1);
                const clearImages = () => refImages.value = [];

                // Editor with CORS Check
                const openEditor = (idx) => {
                    const imgData = refImages.value[idx];
                    
                    // Simple check: If it's a remote URL (not a file upload base64), it might fail
                    // But we will try. If it fails inside initCanvas, we catch it.
                    editor.index = idx;
                    editor.show = true;
                    nextTick(() => {
                        const img = new Image();
                        // IMPORTANT: For local edits, we need Anonymous. 
                        // If server rejects it, onload won't fire or it will error.
                        img.crossOrigin = "Anonymous"; 
                        img.src = imgData.previewUrl;
                        
                        img.onload = () => initCanvas(img, imgData.maskDataUrl);
                        img.onerror = () => {
                            alert("Cannot edit mask for this image due to Browser CORS security restrictions.\n\nYou can still use it as a reference, but cannot draw a mask on it.");
                            editor.show = false;
                        };
                    });
                };

                const initCanvas = (img, existingMask) => {
                    try {
                        const cvs = editorCanvas.value;
                        const container = cvs.parentElement;
                        const ratio = Math.min((container.clientWidth - 40) / img.width, (container.clientHeight - 40) / img.height);
                        cvs.width = img.width; cvs.height = img.height;
                        cvs.style.width = `${img.width * ratio}px`; cvs.style.height = `${img.height * ratio}px`;
                        ctx = cvs.getContext('2d');
                        ctx.drawImage(img, 0, 0); // This line throws security error later if tainted
                        if (existingMask) { const m = new Image(); m.onload = () => ctx.drawImage(m, 0, 0); m.src = existingMask; }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const startDraw = (e) => { isDrawing = true; drawing(e); };
                const stopDraw = () => { isDrawing = false; ctx && ctx.beginPath(); };
                const drawing = (e) => {
                    if (!isDrawing) return;
                    const rect = editorCanvas.value.getBoundingClientRect();
                    const x = (e.clientX - rect.left) * (editorCanvas.value.width / rect.width);
                    const y = (e.clientY - rect.top) * (editorCanvas.value.height / rect.height);
                    ctx.lineWidth = editor.brushSize; ctx.lineCap = 'round'; ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
                };
                
                const closeEditor = (save) => {
                    if (save && editor.index > -1) {
                        try {
                            const temp = document.createElement('canvas'); temp.width = editorCanvas.value.width; temp.height = editorCanvas.value.height;
                            const tCtx = temp.getContext('2d'); tCtx.fillStyle='#FFF'; tCtx.fillRect(0,0,temp.width,temp.height); tCtx.drawImage(editorCanvas.value,0,0);
                            refImages.value[editor.index].maskDataUrl = temp.toDataURL('image/jpeg', 0.9);
                            refImages.value[editor.index].hasMask = true;
                        } catch (e) {
                            alert("Cannot save mask: CORS restriction on this image.");
                        }
                    }
                    editor.show = false;
                };

                const generate = async () => {
                    if (!prompt.value) return;
                    isGenerating.value = true; errorMessage.value = ''; streamingLog.value = 'Connecting...'; currentResult.value = []; markdownBuffer = '';
                    
                    const content = [{ type: "text", text: prompt.value }];
                    for (let img of refImages.value) {
                        // If it has a mask, use mask data (Base64)
                        // If it is a file upload, use previewUrl (Base64)
                        // If it is a remote URL, pass URL string
                        const urlToSend = img.hasMask ? img.maskDataUrl : img.previewUrl;
                        content.push({ type: "image_url", image_url: { url: urlToSend } });
                    }

                    try {
                        const response = await fetch('/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.value}` },
                            body: JSON.stringify({
                                model: computedModelName.value,
                                messages: [{ role: "user", content }],
                                stream: true,
                                n: config.n
                            })
                        });

                        if (!response.ok) {
                            let errorDetail = `HTTP Error ${response.status}`;
                            try {
                                const errorJson = await response.json();
                                if (errorJson.detail) errorDetail = errorJson.detail;
                                else if (errorJson.message) errorDetail = errorJson.message;
                            } catch (e) {
                                if (response.statusText) errorDetail = response.statusText;
                            }
                            throw new Error(errorDetail);
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop();

                            for (const line of lines) {
                                if (line.trim() === '' || !line.startsWith('data: ')) continue;
                                const jsonStr = line.substring(6);
                                if (jsonStr === '[DONE]') break;
                                try {
                                    const json = JSON.parse(jsonStr);
                                    const delta = json.choices?.[0]?.delta || {};
                                    if (delta.reasoning_content) streamingLog.value = delta.reasoning_content.substring(0, 50) + '...';
                                    if (delta.content) {
                                        if (delta.content.includes('Error')) { errorMessage.value = delta.content; isGenerating.value = false; }
                                        else {
                                            markdownBuffer += delta.content;
                                            const matches = [...markdownBuffer.matchAll(/!\[.*?\]\((.*?)\)/g)];
                                            if (matches.length) currentResult.value = matches.map(m => ({ url: m[1] }));
                                        }
                                    }
                                } catch (e) {}
                            }
                        }
                    } catch (e) { errorMessage.value = e.message; } 
                    finally {
                        isGenerating.value = false;
                        if (!errorMessage.value && currentResult.value.length) {
                            history.value.unshift({ id: Date.now(), prompt: prompt.value, images: JSON.parse(JSON.stringify(currentResult.value)) });
                            saveHistory();
                        }
                    }
                };

                onMounted(() => { updateIcons(); updateTheme(); loadHistory(); });

                return {
                    apiKey, prompt, isGenerating, streamingLog, errorMessage,
                    refImages, currentResult, history, allHistoryImages, config, selection, models,
                    editor, editorCanvas, isDragging, gridClass, isDark, lightbox, lightboxEl,
                    dynamicAspectClass,
                    handleDrop, handleFileSelect, removeImage, clearImages, addRefImage,
                    openEditor, startDraw, drawing, stopDraw, closeEditor,
                    generate, toggleTheme, clearHistory,
                    openLightbox, closeLightbox
                };
            }
        }).mount('#app');
    </script>
</body>
</html>